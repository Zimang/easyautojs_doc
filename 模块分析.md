[TOC]



### FlowBuilder（流程构建模块）

**职责：**

- 提供图形化 UI，允许用户拖拽、编辑流程结构。
- 用户在界面中添加 Block（无参操作）、EntityBinding（图像绑定操作）、SubFlow（子流程嵌套）等。
- 每一个流程的本质是一个 Flow 数据结构的构建。
- 输出 Flow（脚本的 DSL 表示形式）。

**输出：**

- Flow 对象（可被传给 DSL 模块）。



### ScriptDSL（DSL解析与生成模块）

**职责：**

- 解析并管理 Flow 结构数据。
- 提供两类输出：
  - JSON：用于保存、加载、存储、版本管理。
  - JavaScript：作为最终运行脚本（Auto.js）。
- 支持每个操作的模板化生成，也支持 `customCode` 直接插入 JS。
- 可以作为代码生成器，也可作为持久化载体。

**输入：**

- Flow（来自 FlowBuilder）

**输出：**

- JSON（中间存储、可导入导出）
- JavaScript（最终运行代码）



### CodeRenderer（代码渲染模块）

**职责：**

- 将 ScriptDSL 模块生成的 JavaScript 脚本渲染为带语法高亮的 UI。
- 支持主题切换（如暗黑、护眼、高对比等）。
- 支持只读总览视图（展示完整脚本）和局部编辑视图（操作级别代码编辑）。
- 提供编辑后的 JS 片段，回写到 Flow 的 customCode 字段中。

**输入：**

- JavaScript 字符串（来自 ScriptDSL）

**输出：**

- 代码高亮渲染视图（UI层直接显示）





### EntityOperationManager（实体与操作管理模块）

**职责：**

- 管理脚本中的操作与实体资源，包括注册、展示、标记、编辑等。
- 不负责生成，只接受外部组件/服务生成的实体和操作。
- 提供必要的展示数据给 UI 层，同时支持轻度编辑（如操作体替换）。
- 对接外部接口时只接收结构化变更结果，不参与实际处理逻辑。

**输入：**

- 实体定义结构（Entity）：图像或 UI 组件信息
- 操作定义结构（Operation）：函数名、参数、模板代码
- 用户对操作的自定义代码（customCode）
- 外部接口返回的结构化变更信息（如 Entity 修改补丁）

**输出：**

- 实体列表（包含预览图、类型、元信息等，用于拖拽、选择）
- 操作列表（支持展示原始模板和 customCode）
- 结构体用于 FlowBuilder 构建 EntityBinding 或 Block
- 供 UI 使用的预览、标签、命名、引用信息等辅助展示数据





### ADBService（ADB服务模块）

**职责：**

- 提供与 Android 设备通信的统一接口，封装 ADB 及相关工具（如 apktool）调用。
- 支持脚本推送与执行、截图与图像检索、设备识别、日志过滤、模拟器特化能力。
- 不承担 UI 操作录制、可访问节点解析（AccessibilityNodeInfo）等职责，保持清晰边界。
- 对图像识别与高级任务执行提供标准插件接口（可本地、远程、异构实现）。

------

**输入：**

- JS 脚本（字符串或文件）
- 图像（用于识别）
- 控制命令（tap、swipe、back 等）
- 设备标识或模拟器标识
- 操作选项（如是否使用识别插件、过滤规则）

------

**输出：**

- ADB 命令执行结果（成功 / 异常）
- 屏幕截图（本地文件 / 字节流）
- 日志输出（原始 + 过滤后）
- 包名 / 活动名 / 设备信息
- 图像识别结果（识别位置 / 匹配失败）

------

**模块扩展点（新增）：**

1. **打包支持（apktool + ADB）**
   - 解包 APK → 替换 assets 中脚本文件 → 重新打包 APK → adb install
   - 可插拔打包策略（如 hook assets 或 dex patch）
2. **开放图像识别插件系统**
   - 默认识别流程：adb push 图片 → 运行脚本 → SD 卡返回位置
   - 插件替换方式：
     - 本地识别（提前截图 → 本机分析）
     - 持续运行 Auto.js 脚本 + Socket 通信
     - http API 调用设备端识别服务
   - 输出统一为：坐标、置信度、失败标记
3. **日志分发与过滤**
   - 拉取完整 logcat → 分类转发
     - Auto.js 本体日志
     - 当前 App 日志（包名）
     - 脚本中目标 App 日志（配置项）
   - 允许设置过滤条件（关键字、等级、时间）
4. **多设备/模拟器管理**
   - 支持 adb 的 `-s`、`-t` 选项选择设备
   - 支持多设备并发管理
   - 开放接口供：
     - 模拟器重启（雷电模拟器命令行）
     - 指纹伪造（dconsole 配置）
     - 设备重命名与记录管理

------

**设计原则：**

- 所有核心操作以“接口”形式暴露，不绑定特定实现方式
- 核心功能使用协程调度，支持异步与并发
- 模拟器特化功能通过插件注册（比如 `BluestacksPlugin.kt`, `LDPlayerPlugin.kt`）
- 模块应允许脱离 Compose 独立运行，便于测试与部署

------

**不做的事：**

- 不负责图像识别算法实现本身（交由插件）
- 不处理屏幕实时录制、UI结构可视化（拆分至 Recorder 模块或 AccessibilityService 模块）
- 不承担 UI 层功能，仅提供 RPC/接口

------



### EntityOperationGenerator（实体与操作生成模块）

**职责：**

- 监听并采集用户在设备屏幕上的交互行为（鼠标轨迹、点击、输入等）
- 实时同步设备 UI 渲染树，并提供组件悬停高亮与结构树标注功能
- 自动判断用户行为对应的操作（click/gesture）并生成结构化记录
- 允许用户通过快捷键或点击将屏幕区域/UI组件保存为实体（Entity）
- 输出 Entity 与 Operation，可直接供 FlowBuilder 使用

**输入：**

- 屏幕画面（截图或流）
- 设备 UI 层级结构
- 鼠标/键盘交互事件

**输出：**

- 实体（图像实体 / UI 组件实体）
- 操作（click / gesture / sleep 等）



### EntityOperationGenerator（实体与操作生成模块）

**职责：**

- 监听并采集用户在设备屏幕上的交互行为，用于生成实体（Entity）和操作（Operation）。
- 区分两类交互录制方式：无参操作的**实时录制**与有参操作的**静态锚点录制**。
- 实时同步设备 UI 渲染树，支持组件高亮、结构树同步选中与标注。
- 支持多种方式创建实体，包括：实时截图、UI树选中、截图内裁剪、手动输入 selector。
- 操作可通过鼠标轨迹自动判断 click / gesture / sleep，录制可暂停、继续或结束。
- 提供“锚点视图”（目标图A + 背景图B）的切换机制，辅助用户构建有参操作的相对或绝对定位。

**输入：**

- 屏幕画面（实时截图或流）
- 设备 UI 渲染树（结构 dump）
- 鼠标/键盘交互事件
- 快捷键指令（如选中、暂停、隐藏背景等）

**输出：**

- 实体（图像实体 / UI 组件实体）：
  - 来源包括：截图裁剪、UI结构选择、手动输入
- 操作（click / gesture / sleep）：
  - 无参操作：通过轨迹实时记录
  - 有参操作：绑定目标实体 + 相对/绝对位置录制
- 锚点绑定结构（Entity + Operation 合成的 EntityBinding，可供 Flow 使用）

           EntityOperationGenerator
             /                  \
     实体采集器               操作采集器
      (Entity Capture)           (Operation Capture)
        ├── 实时截图拖选         ├── 无参操作实时录制
        ├── UI结构树点击         ├── 有参操作锚点绑定 + 静态录制
        ├── 静态截图拖选         └── 手动构造/组合
        └── 手动填写组件属性




### ScriptProjectStore（脚本项目与资源存储模块）

**职责：**

- 管理每个脚本项目的本地资源，以包名为单位组织项目目录。
- 存储与读取项目中的 DSL 脚本结构（Flow）、操作（Operation）、实体（Entity）、生成的 JS 代码、APK 文件、图像资源等。
- 提供统一的接口供其他模块（如 FlowBuilder、EntityOperationGenerator、CodeRenderer）读写项目资源。
- 提供入口 UI 界面：列出所有项目，标记最近使用的项目，允许新建、删除、编辑项目。
- 不直接管理或共享“公共内容”，但支持用户手动将公共资源（如 customUtils.js、sharedAssets）复制进项目中使用。
- 支持导入导出项目、路径映射、标签分类、项目级备注说明等功能。
- 支持未来切换数据库作为持久化后端，并输出性能评估报告。

**输入：**

- 项目信息（包名、路径、项目名、备注、标签等）
- 项目资源结构（Flow、Entity、Operation、JS、APK、图片等）
- 用户界面操作（创建、打开、删除、搜索、排序）
- 文件系统操作指令（保存、读取、删除、导入导出）

**输出：**

- 当前选中项目的资源引用（供 FlowBuilder 等模块使用）
- 项目元数据（上次编辑时间、资源数量、标签等）
- 项目总览 UI（项目卡片、搜索栏、新建按钮、最近使用分组）
- 可导出的项目包（ZIP 或标准目录结构）

**界面功能：**

- 显示所有项目（支持名称搜索、标签过滤、按时间排序）
- 高亮最近使用项目
- 提供项目新建按钮（输入名称/包名后生成目录结构）
- 提供删除项目按钮（需二次确认）
- 可选：项目重命名、设置备注/标签等扩展功能

**备注：**

- 公共资源（如 `customUtils.js`, `sharedAssets/`）由用户维护于项目目录之外，使用时需手动复制入项目。
- 所有项目内容必须本地完整保存，不支持跨项目引用。
- 所有资源均映射为可视文件，支持未来切换到数据库索引优化。

------



### ScriptExecutor（脚本运行器模块）

**职责：**

- 负责将生成的 JS 脚本推送至目标设备并启动执行。
- 管理脚本执行生命周期，**通过运行一个“宿主脚本（host）”来间接控制目标脚本的启动与终止**。
- 提供统一的执行接口，供 UI 按钮触发“运行”、“中止”、“重启”。
- 通过轮询通信机制，判断用户是否点击了“结束按钮”，以决定是否终止目标脚本。

**执行机制：**

1. 推送两个脚本至设备：
   - `host.js`：作为控制脚本，负责监听是否应启动/终止目标脚本
   - `target.js`：实际业务脚本，由 host 动态执行
2. 启动 host.js（通过 ADB 启动广播或运行 shell）
3. host 脚本周期性访问指定接口（可由本机提供 HTTP API 或通过文件标志位）
4. 用户点击“结束脚本” → 修改状态接口 → host 接收到信号后终止目标脚本（如 kill thread、调用 exit、通过状态控制主动 return）

------

**输入：**

- 已生成的 `target.js` 脚本路径
- 控制指令（运行、终止、重启）
- 用户交互状态（是否点击“结束”）

**输出：**

- 运行状态信息（是否启动、是否结束、是否异常退出）
- 当前执行日志（可选）
- 错误或运行结果反馈

